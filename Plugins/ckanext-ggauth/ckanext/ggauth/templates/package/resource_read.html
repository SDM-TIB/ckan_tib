{% ckan_extends %}

{% set pkg = c.pkg_dict or pkg_dict %}
{% set res = c.resource %}
{% set ask_url = h.url_for(controller='ckanext.ggauth.controller.permissions:PermissionController', action='ask_permission', id=pkg.name, resource_id=res.id) %}
{% set can_download = h.check_access('resource_download', {'user':c.user, 'resource_id':res.id, 'id': pkg.id }) %}
{% set can_preview = h.check_access('resource_schema', {'user':c.user, 'resource_id':res.id, 'id': pkg.id }) %}
{% set ignore_fields = ["download", "preview", "resource"] %}

{% block resource_read_url %}
	<!-- Check if has permission to download -->
    {% if can_download %}
		{{ super() }}
	{% else %}
		<p class="muted ellipsis"> This resource download URL has been hidden. <a href="{{ ask_url }}">Ask for permission.</a></p>
	{% endif %}
{% endblock %}

{% block resource_view %}
	<!-- If has permission to see the resources -->
	{% if can_preview %}
		{{ super() }}
	{% else %}
		<p class="muted ellipsis text-center"> This resource preview has been hidden. Ask for permission. </p>
	{% endif %}
{% endblock %}

<!-- Filter out the privacy preferences -->
{% block resource_additional_information_inner %}
        <div class="module-content">
          <h2>{{ _('Additional Information') }}</h2>
          <table class="table table-striped table-bordered table-condensed" data-module="table-toggle-more">
            <thead>
              <tr>
                <th scope="col">{{ _('Field') }}</th>
                <th scope="col">{{ _('Value') }}</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th scope="row">{{ _('Last updated') }}</th>
                <td>{{ h.render_datetime(res.last_modified) or h.render_datetime(res.revision_timestamp) or h.render_datetime(res.created) or _('unknown') }}</td>
              </tr>
              <tr>
                <th scope="row">{{ _('Created') }}</th>
                <td>{{ h.render_datetime(res.created) or _('unknown') }}</td>
              </tr>
              <tr>
                <th scope="row">{{ _('Format') }}</th>
                <td>{{ res.mimetype_inner or res.mimetype or res.format or _('unknown') }}</td>
              </tr>
              <tr>
                <th scope="row">{{ _('License') }}</th>
                <td>{% snippet "snippets/license.html", pkg_dict=pkg, text_only=True %}</td>
              </tr>
              {% for key, value in h.format_resource_items(res.items()) %}
                {% if key not in ignore_fields %}
                  <tr class="toggle-more"><th scope="row">{{ key }}</th><td>{{ value }}</td></tr>
                {% endif %}
              {% endfor %}
            </tbody>
            </table>
            </div>
{% endblock %}


<!-- Privacy preference module -->
{% block resource_additional_information %}
	{{ super () }}

	{% if res %}
        <div class="module-content">
          <h2>{{ _('Privacy policy') }}</h2>
          <table class="table table-striped table-bordered table-condensed" data-module="table-toggle-more">
            <thead>
              <tr>
                <th scope="col">{{ _('Field') }}</th>
                <th scope="col">{{ _('Value') }}</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th scope="row">{{ _('Download') }}</th>
                <td>{{ res.download }}</td>
              </tr>
              <tr>
                <th scope="row">{{ _('Preview') }}</th>
                <td>{{ res.preview }}</td>
              </tr>
              <tr>
                <th scope="row">{{ _('Schema') }}</th>
                <td>{{ res.schema }}</td>
              </tr>
            </tbody>
          </table>
        </div>
    {% endif %}
{% endblock %}